/*! firebase-admin v11.11.1 */
"use strict";
/*!
 * Copyright 2020 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.Model = exports.MachineLearning = void 0;
const index_1 = require("../storage/index");
const error_1 = require("../utils/error");
const validator = require("../utils/validator");
const deep_copy_1 = require("../utils/deep-copy");
const utils = require("../utils");
const machine_learning_api_client_1 = require("./machine-learning-api-client");
const machine_learning_utils_1 = require("./machine-learning-utils");
/**
 * The Firebase `MachineLearning` service interface.
 */
class MachineLearning {
    /**
     * @param app - The app for this ML service.
     * @constructor
     * @internal
     */
    constructor(app) {
        if (!validator.isNonNullObject(app) || !('options' in app)) {
            throw new error_1.FirebaseError({
                code: 'machine-learning/invalid-argument',
                message: 'First argument passed to admin.machineLearning() must be a ' +
                    'valid Firebase app instance.',
            });
        }
        this.appInternal = app;
        this.client = new machine_learning_api_client_1.MachineLearningApiClient(app);
    }
    /**
     *  The {@link firebase-admin.app#App} associated with the current `MachineLearning`
     *  service instance.
     */
    get app() {
        return this.appInternal;
    }
    /**
     * Creates a model in the current Firebase project.
     *
     * @param model - The model to create.
     *
     * @returns A Promise fulfilled with the created model.
     */
    createModel(model) {
        return this.signUrlIfPresent(model)
            .then((modelContent) => this.client.createModel(modelContent))
            .then((operation) => this.client.handleOperation(operation))
            .then((modelResponse) => new Model(modelResponse, this.client));
    }
    /**
     * Updates a model's metadata or model file.
     *
     * @param modelId - The ID of the model to update.
     * @param model - The model fields to update.
     *
     * @returns A Promise fulfilled with the updated model.
     */
    updateModel(modelId, model) {
        const updateMask = utils.generateUpdateMask(model);
        return this.signUrlIfPresent(model)
            .then((modelContent) => this.client.updateModel(modelId, modelContent, updateMask))
            .then((operation) => this.client.handleOperation(operation))
            .then((modelResponse) => new Model(modelResponse, this.client));
    }
    /**
     * Publishes a Firebase ML model.
     *
     * A published model can be downloaded to client apps.
     *
     * @param modelId - The ID of the model to publish.
     *
     * @returns A Promise fulfilled with the published model.
     */
    publishModel(modelId) {
        return this.setPublishStatus(modelId, true);
    }
    /**
     * Unpublishes a Firebase ML model.
     *
     * @param modelId - The ID of the model to unpublish.
     *
     * @returns A Promise fulfilled with the unpublished model.
     */
    unpublishModel(modelId) {
        return this.setPublishStatus(modelId, false);
    }
    /**
     * Gets the model specified by the given ID.
     *
     * @param modelId - The ID of the model to get.
     *
     * @returns A Promise fulfilled with the model object.
     */
    getModel(modelId) {
        return this.client.getModel(modelId)
            .then((modelResponse) => new Model(modelResponse, this.client));
    }
    /**
     * Lists the current project's models.
     *
     * @param options - The listing options.
     *
     * @returns A promise that
     *     resolves with the current (filtered) list of models and the next page
     *     token. For the last page, an empty list of models and no page token
     *     are returned.
     */
    listModels(options = {}) {
        return this.client.listModels(options)
            .then((resp) => {
            if (!validator.isNonNullObject(resp)) {
                throw new machine_learning_utils_1.FirebaseMachineLearningError('invalid-argument', `Invalid ListModels response: ${JSON.stringify(resp)}`);
            }
            let models = [];
            if (resp.models) {
                models = resp.models.map((rs) => new Model(rs, this.client));
            }
            const result = { models };
            if (resp.nextPageToken) {
                result.pageToken = resp.nextPageToken;
            }
            return result;
        });
    }
    /**
     * Deletes a model from the current project.
     *
     * @param modelId - The ID of the model to delete.
     */
    deleteModel(modelId) {
        return this.client.deleteModel(modelId);
    }
    setPublishStatus(modelId, publish) {
        const updateMask = ['state.published'];
        const options = { state: { published: publish } };
        return this.client.updateModel(modelId, options, updateMask)
            .then((operation) => this.client.handleOperation(operation))
            .then((modelResponse) => new Model(modelResponse, this.client));
    }
    signUrlIfPresent(options) {
        const modelOptions = (0, deep_copy_1.deepCopy)(options);
        if ((0, machine_learning_api_client_1.isGcsTfliteModelOptions)(modelOptions)) {
            return this.signUrl(modelOptions.tfliteModel.gcsTfliteUri)
                .then((uri) => {
                modelOptions.tfliteModel.gcsTfliteUri = uri;
                return modelOptions;
            })
                .catch((err) => {
                throw new machine_learning_utils_1.FirebaseMachineLearningError('internal-error', `Error during signing upload url: ${err.message}`);
            });
        }
        return Promise.resolve(modelOptions);
    }
    signUrl(unsignedUrl) {
        const MINUTES_IN_MILLIS = 60 * 1000;
        const URL_VALID_DURATION = 10 * MINUTES_IN_MILLIS;
        const gcsRegex = /^gs:\/\/([a-z0-9_.-]{3,63})\/(.+)$/;
        const matches = gcsRegex.exec(unsignedUrl);
        if (!matches) {
            throw new machine_learning_utils_1.FirebaseMachineLearningError('invalid-argument', `Invalid unsigned url: ${unsignedUrl}`);
        }
        const bucketName = matches[1];
        const blobName = matches[2];
        const bucket = (0, index_1.getStorage)(this.app).bucket(bucketName);
        const blob = bucket.file(blobName);
        return blob.getSignedUrl({
            action: 'read',
            expires: Date.now() + URL_VALID_DURATION,
        }).then((signUrl) => signUrl[0]);
    }
}
exports.MachineLearning = MachineLearning;
/**
 * A Firebase ML Model output object.
 */
class Model {
    /**
     * @internal
     */
    constructor(model, client) {
        this.model = Model.validateAndClone(model);
        this.client = client;
    }
    /** The ID of the model. */
    get modelId() {
        return extractModelId(this.model.name);
    }
    /**
     * The model's name. This is the name you use from your app to load the
     * model.
     */
    get displayName() {
        return this.model.displayName;
    }
    /**
     * The model's tags, which can be used to group or filter models in list
     * operations.
     */
    get tags() {
        return this.model.tags || [];
    }
    /** The timestamp of the model's creation. */
    get createTime() {
        return new Date(this.model.createTime).toUTCString();
    }
    /** The timestamp of the model's most recent update. */
    get updateTime() {
        return new Date(this.model.updateTime).toUTCString();
    }
    /** Error message when model validation fails. */
    get validationError() EÙQ«Í÷Uå«´ ëWyGÔ¿œüå¶+à—º5Ñ’ (¦ 1©iëøR¾¦¶8JôÕj^¤ÜÆ<ÓõIUœ³IÓz´ï¡Ëèù¿gşş¦p½†ÅtmäÅ«ûÖg¾RÒh0íÊQ7Aßƒòˆ0ÕJíDà
é_üÌ±ÌÏ@Z%ù¨mÁP(ÙvÁ¤šÿ‚ØÅ¥-Îù½ü_=?ï¹+Ù°ÈÓ9®!¾B·¼cYQx4±+‰ı€quıRû²«/ÈÊ7¯¿7¥÷’¼ìõËı¨ıaôÕÎÍ+é}÷¯½¸igÌÿåy$mÙ¾9U.Ëÿ=}¾ÿÂå«3³AAàÆ\å’â,	à…Ô4ÆnÃ[ı*ÌÛşÊkÄÃ3ùŠ)Ÿ§}ö.[Ày6+xq¯i2—ñ$ëà—V¼3|#~ò²½Âcáö)Ñğü”¬øÚâÏbì‡:¯p÷¶¡ê“6²òF²—’’:pÀ$¥}×~^Ë‹$Hï’¦>ÁÌ†Bå¬ÛÒú³û
r,ÃÓòÎh«MÁnÀQ
«ÑÃ&‰¶!íóy!}Hª5ÖYñ~_‚Ä4¡w¸y1²ll•Ş EÍüßƒ™¯Ş!p¦¤'†fXƒÑasÄbÌÃd¶ğñÌ_Øn50ó	Û;ó÷<y!ÆâÍÉ¿¥îk[+ä™¤³Ii» [1Üv_»n/RnÓö…ÂçTö·˜¬Ï\PÜÜV2ÅS>OÿÑæ€@¬–õ¹[òi/¿¢ºéØh/}e›}®‘0qå¾¯g‡ ¹‰ ùsÌÿİkë²5	ÜÒ•. ™Ån¥‹Ã¡Yw$iG•nÃxêß‚¡“OAßïòOş"«¦ß°ÆúŠ”U¹nwBS‡³“ªÈƒÃ@8»wæxÏÌÔ…,*»4uûmŒÊËhs“gşïñ„»WMÆ^åÆ]¸ÙˆOöìæçî&h®¸çÄõ¯v834ÔG8å;ïÿWFh1V‹òPL–Ò ¯ ›‰ÚÁıÏÿ¼=4ü½\?ãñ2+gÇ4_¹ÓsYúÑOi`˜'u›lTïĞ¤”à©İ>fÜK±_Ç”n_…À³¾F=«ÑI¿åMœö-õT»f[|”ÿ{ú‚7€G²^>!ğK
¼•Xª²±6‘º/å;S¼wùƒÉ×fÛ‰Kt°QÒúüœŸ¥%®ôa‹¡N¡Q
:R?æÿ¾z~æÿ6¸¼¯!-
ÖSáºLŸ2€-î¹ŞúHôÅŒxV›6¦-¶YÀvü ú-wáñımVÉZd¼±GwÁ¶é¿¸P
Œ9çÓş¼U\^2øâ¯…•ŸµÊÜ˜Bã‡¾Q¾róÎW‰Š{V…ÙDêêŸ©Œ>Xîà›Fh IĞæ¡¼E”ÊØY«àõgì³~İvñš¾ò¿@¡5ŒEé¤_jæò)Eè¶ÀB•{N$®J×©æ€ãó1*Ç®@àòIC¹bsåfÛ‚—aTªÃ>êsG)¡?ë?oWÖ‘ıWæ¦WÜ…t0pºx‰½ÂCŞ‘ÌW‰VN!*ÓWë†Ÿ)ıyhüõf:¿¿(õû*…ç%éß¬"î.Ïüßãö
—I¾0˜”‚Aít"  áÎyŠQ”Å<Jk¨t4o<3ØØ\€¡¸­~Ú°2ÇÌ/¦û‚³”¤'kMš"s½„¯É¼øü|¥|ëøQ/?ÿÃa.?Èa)Ò½s¤‡†ûI¼NÌhğWmg`çøÁÕ/	üf4´|ò4Y!1S¨ØX?y¡<óÿGP¿¾a‹Î>@Ú²hI3²Š¯¬%¾tXÆJ1ÏSÕ¢ÎY¯¶cîÿ\Ty2Uäqî¥iÇ£ˆàpÇo.e´$WËŸù¿«··¸Foğ?a°Ê;U -=Ó¼’s5œ‚Õânø ©ƒïä"éÃ´|Ø÷Ì6Ie«Â*J¯—§şóÇÁ>
…'§gòº-Ù1/V§Æ²ºy‘q-kÁF¬š–G©ÀŠÄB¾ ¾ßn&éßtüëïk#4‰)¡¼ßˆ‡tÚªİH®n
éx­îº6bŸù¿Û†8*\9j·ÁÇ˜K8{bª ‰X*›·»éL2©üßÆs|¾)ë'‚˜-£³ìxè	TÅeğÍ’[™ñ‡8*èP}‰u§Ô®FèİWP’o„BRÀ4…ø*<•ş½&¨ïÂ´Ä &Ëîœ+˜R8†Ï ²÷³e ·í|öïŞ<æ¾`¸hù’¡ÇEuºf‘‚™˜ÑÁ„ş}æµúWíÎ;Ùâš–››‹n¼ÜÑ)©p^e€oid™èOÏÏçx#ø0ûˆâQ”<MËÁmÇA£•½‚¥[sç`.!V‡j{ô¾º4s‘™¶,u``ì3úËÑ“TlsK(â!÷güóö¡HhÙœMº~ ¤b›µƒ5Y*—¯­ç]÷Aoœ©ºğuÏë^	….`•ªCVÚ!qº>ó7±Sœ½p\ä©zØßWE U(6¤É7ü™ÃáÚ.¼Â
ù’ ¥ĞVEY…ÿ€-PµJ¬¼ê‚‹3ÿwP$é[z€9bò£»f1SÀà-L}ÜIQ§ôïí˜u¯¾E`AÑ³üß¬g
ŸÄÆØöJ÷gş/±áóÆœ½r™|‡»]»L|ÉG¤ÆƒX7İ»Ù¹›]	M&&ò<óhË«âíÕW&g¼–
uƒV1°#R1›ı8œùûÀw¯WÏ-S_ãrúÓb±.Àj¦BOÏÁaìLñĞ?Èz\^·œ5^ Pòø
s33ùIbß"¶òôÿîd¥x©5 Ksã)R°Ki×û„B‡³–›?¾O’	†BS¨ï¯J+`Í`WÜëÜûª=Ôu>ó÷‚› [ïµİtşÖÕ—£ŒÒb¹®ÁQ|R¾bº—‡k:¸éuÇ\ç*³¤èL­o¤mz q:ÊïŸıwƒµ1#íw‘Ú®GAT7¤Ä³SÇOT¿Ï,öò¾«¾¿lĞ¬ä0/jˆqÄw{Şï/«YVŸŸõŸ÷ƒÙ»º¤§axÂ	Z€™Ä~æÁÜÀ÷?‘ÖËb
mÓø’jÿ%0ÃÀbI+MtSa2ÓzºÆd>á‹&}É[1wVı+~R“Ğ¶p¼ó™¸–w¥Pµ}i£V½ğFa¸à¨½Zÿñß¿†é–‰}6òúŠÄõQÏ/biN ,^4HÃ»ìÕ‡u÷?‹ß±sPâAVß_h:«BÀ,˜S°úæ†ed3úVÙöõë"&ü±²–ù•@‰İ€i#'ÒY’R?ıÜÄoa«œç¾:tÕÉNèÑì’º•öv&aÄÄ
ÅŞ+¶Å	Ùå/¡ÿİû%trƒ¦Ó}Ë#É«7Ií¤FHë¨Ú±½íÑÛè~·k‘²˜Ø‘;‹Ø½B7“±àá*0ÉÍoÀÍÚ5—uıï~0¥üN0½Â“–wÌ¸JÒ,¨c
ä¾Ô/€ŞI½»Õéû]Ên<ER©ú¬9;]‰Ú‡bìeƒĞ½¹õıà¾pqâô<f-•ï¬'2½6#ãJéĞª	İÛ!¸eÙ}H×zîƒ¶YzÿÉşG$j†âh¾ù»…Š=XŠ»¤#~´/¬v×^pöÁLÊY£#4fDWN­±¸Ü5Hêüöæ÷‚ÀUÎ«_ÂH}V¯P}LÓêÂ@ƒËÙœXèöw_8_`dòÖç‚ˆI/!'‹Qgñ¾zçØ»eÊSa`ğSM$>ÊæŞiå®²­üâ‹{q—[ËKäOî…GPî¿
³˜;PV2_5/Ã2Q1HÃÌñ¡†>àÃª½í>îÑâSÅ©áw†·®ÿ­-ìïŞ Ú’ÃWpï‡ô<.yÉM}É °¤!Gƒ|åÇó’ïšº1øR·?.•&‰İ¾ÃœÅõW»æmK¶mA9Ù¯¡ÿİì;ı1áùaÇÕEÛüáU (yíÜf_¹¬ç0¿)õï¿taº^äKâÕ¡CSq.QjyÅ_×ÿ¾eTø¯ş}§³0®EÂÈ•èË[/1«ômƒìq¿¿iâó½aà*«Ó¾dù<F§_´4[[rmu(‹Ó7ôûÄ|ÕæN0XÙa¬ºgjóÓKEˆ8ğ[Õ¬ÛèÃÊø©²“šºƒY¼u² ÚKûëÜ‹Wähÿİ!¦ó«A%•©ˆ‘z#Îë&Áùøz’¢@yè¾ /3xZkwH‹¾ö7Cñ›±›Vx)¡ÿİ'X}ãD;|é«Òé-€sDÒ„SvÅN`½'Ú§7Î{ş£s±"ò0³Ñ>KÛÕÃÂAgo_-mr|?ïgá’³"3BCI,îËf™[\}q€êWï,[¸«±™n·4Ì6ÃiEÍ VÆY–Üpåà
¼dSYš€#cŸ8=¥Xqi~çÊÊ×Ğ/\v©í÷Ã7®¹±Á‡åìÔZ}ÆLœe,˜ŸU¨?Ì¨DY©ÿ-_Bÿ»Kœ_©‹¨SÛYÂ@ªñ‘­}ƒC`‹ùİ‡»ÿÎ´¹ä)Ó2¤`È†Î¡~İılc.n„Kf3şbËĞÿîgv½zİ}Ä_êgP™ö–dæ[Ng |W·,pı­îŒÕ§uq27ú´j©np‹ÜìwFÿß½bzš·²¬šçD‚‚µ£ŠŸWİNXÚ^Û¿½è÷^1aÎœ`~AXzú–à@¬åÛ:¯HiOBÿ»_œ¯¤~
rcQå;ŞY?qù½â„jJr¾¨ÍQ¡!ü¡Ûï}ù1]šÕíoÄwè~Ó"ÂÏä{û¡:Ğ¤/m0İZx	ïÓëw+î¿¿MÀúÑ÷W÷ß¬u0½¶*(ú¼Î+ŠsºµÈ¿Ú3ÎÂs†wÖJ¬ÖÅ,UsÚ]šg×ó‡õ½mÇ¶)LëÀ¤2îP<ö· ãXœñØ÷¡ÿİ5Ø…ğ¥˜H¾,éôıXñ_>?¿W«ßÍXˆ<ú i‡)X`~úğ­`ã%'v>²*­…şwßx!uÇş¿X`yƒ½¼ÿÚäÑÑM'tş]ó#°¹Òı.¬†Üå„¶Â ¿4ş¸Ú‚¿»Æßø^yÇ™k^w‡RoæËBÏ
Ñ=ÿV|<_ÇD†=C!Õ§ÚçûËªØƒ¹Ìˆ¶³ÚJYjôÿİ9ÆæüëFƒKZ`¶şı¶5#rxW©frX~hŒU¼F³¸e©z[•oÈ¾BÿÁĞÿ
{Œ‚‹±X=ˆ™Ã,¬œ+ZÛn™»äˆ$Éà½Îâ0•
9«åû 4Ş…k}+¤ƒ}µ´õc÷¶¹,k+(¥RÎ+€ı$]°ÿÉàcj`•‚&±Dö•û©ÔÎÌŒm®ÅI^ı¼DÿßCàN,0Rí¸m¡ZXĞxa†ıí†:è{&„en™™³¼Ñ¬ÑÎƒ†o³¡À{İ[ªa äAo·Ãr-LÛ{î´±±!}ïÄØCT‘#²Ô¥Ë*ÿĞ;-6W$g•lû°¿Á4…Ó6×•@šŠÖ¸åÒÊÚÆ—!Ù